<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Frontend Code Camp Quiz Result</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

  <link rel="stylesheet" href="assets/css/style.css">

  <link href="https://fonts.googleapis.com/css?family=Handlee" rel="stylesheet">


<body>

<div class="quiz-container text-center">
  <h1>Frontend Code Camp Quiz Result</h1>

  <h2 class="timer">
    <span class="cd-min">00</span>:
    <span class="cd-sec">30</span>
  </h2>

  <div class="result-container">
    
    <div class="result template" style="display:none">

    <h2>Level: <span class="txt-level">Beginner</span> </h2>
    
    <table class='tbl-result'>
      <thead>
      <tr>
        <th>Email address</th>
        <th>Score</th>
        <th>Time</th>
      </tr>
      </thead>
      <tbody>
      <tr class='tr-result template' style='display:none' data-weight="0">
        <td class='txt-email'>example@info.fr</td>
        <td class='txt-score'>3</td>
        <td class='txt-time'>120s</td>
      </tr>
      </tbody>
    </table>

    </div>



  </div>
  
  <!--<div class="result-container">-->
    <!--<h2>Level: Beginner level 2</h2>-->
    <!--<table>-->
      <!--<thead>-->
      <!--<tr>-->
        <!--<th>Email address</th>-->
        <!--<th>Question reply correctly</th>-->
        <!--<th>Time</th>-->
      <!--</tr>-->
      <!--</thead>-->
      <!--<tbody>-->
      <!--<tr>-->
        <!--<td>example@info2.co.uk</td>-->
        <!--<td>10</td>-->
        <!--<td>15 mins</td>-->
      <!--</tr>-->
      <!--</tbody>-->
    <!--</table>-->
  <!--</div>-->
</div>
<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script>
var ws = new WebSocket("ws:/ws-devcon.cf:1995");

ws.onopen = function(){
  console.log("connected!");
  var obj = {'type':'fetch-results', 'payload':'completed'};
  ws.send(JSON.stringify(obj));
}

ws.onmessage = function(e){
    var obj = JSON.parse(e.data);
    rankAndShow(obj.payload);

}

function rankAndShow(results){
  console.log(results);

  for(level in results){  
    console.log(level);
    console.log(results[level]);
    console.log('----')

    // $('table.'+level).find('tr.result-row').remove();
    var thisTable = $('div.result.'+level).length != 0 ? $('div.result.'+level) : $(".result.template").clone()
      .removeAttr('style')
      .removeClass('template')
      .addClass(level);
    
    thisTable.find('.txt-level').html(level);

    $(".result-container").append(thisTable);

    for(email in results[level]){

      if (!(results[level][email][0].hasOwnProperty('duration'))) results[level][email][0]['duration'] = 900000;
      var thisRow = thisTable.find('tr.template').clone()
        .removeClass('template')
        .addClass('result-row')
        .removeAttr('style')
        .data('weight',results[level][email][0]['score'])
        .data('time', results[level][email][0]['duration'])
        .data('email',email);

      var dur = results[level][email][0]['duration'] / 1000;
      
      thisRow.find('td.txt-email').html(email);
      thisRow.find('td.txt-score').html(results[level][email][0]['score']);
      thisRow.find('td.txt-time').html(dur+'s');


      thisTable.find('tbody .tr-result').each(function(){
        var currentRow = $(this);
        console.log('email:',email);
        console.log('weight:',thisRow.data('weight'));
        

        if (thisRow.data('weight') > currentRow.data('weight')){
          currentRow.before(thisRow);
          return false;
        } else if (thisRow.data('weight') == currentRow.data('weight')){
          if (thisRow.data('time') < currentRow.data('time')){
            currentRow.before(thisRow);
            return false;
          }
        }

      });
      // .append(thisRow);
      
    }


  

  }
  
}



function countdown(){
  var mins = parseInt($('.cd-min').html(), 10);
  var secs = parseInt($('.cd-sec').html(), 10);
  if (secs==0 && mins!=0){
    secs=59;
    mins--;
  } else if (secs!=0){
    secs--;
  } else if (secs==0 && mins==0) {
    var obj = {'type':'fetch-results', 'payload':'all'};
    ws.send(JSON.stringify(obj));
    window.clearInterval(countdowninterval);
    
  }

  $('.cd-min').html((mins >= 10) ? mins : '0'+mins);
  $('.cd-sec').html((secs >= 10) ? secs : '0'+secs);

}
countdowninterval = window.setInterval(countdown,1000);
</script>
</body>
</html>